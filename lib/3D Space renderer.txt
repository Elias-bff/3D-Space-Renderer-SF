--@name 3D Space renderer
--@author Elias & Bullet Paincakes
--@client

local FPS = 60

local next_frame = 0 
local fps_delta = 1/FPS

renderer=class("renderer")

--[[
function await(name,var,func)
    hook.add("think",name,function()
        if function() return var() end then
            func()
                    
            hook.remove("think",name)
        end 
    end)
end
]]

function renderer:initialize(pos,name,size,parent)
    self.pos=pos
    self.size=size
    self.viewScale=3
    self.name=name
    
    render.createRenderTarget(self.name)

    self.mat = material.create("UnlitGeneric") 
    self.mat:setTextureRenderTarget("$basetexture",name)
    self.mat:setInt("$flags", 0)   
    self.mat:setInt("$flags",256) 
    
    hook.add("renderoffscreen","space_"..table.address(self),function()
        
        local now = timer.systime()
        
        if next_frame > now then 
            return 
        end
        
        next_frame = now + fps_delta
    
        render.selectRenderTarget(name)
        
        render.clear(Color(0,0,0,0))
    
        render.pushViewMatrix({
            type   = "3D",
            origin = render.getOrigin(), --screenEnt:localToWorld(screenEnt:worldToLocal(render.getOrigin()) * Vector(1, 1, -1))
            angles = (self.space:getPos()-player():getEyePos()):getAngle(),
            fov    = 180-(2*(math.deg(math.atan((player():getEyePos():getDistance(self.space:getPos()))/(self.size*self.viewScale))))), --(pla0yer():getPos():getDistance(space:getPos()))
            aspect = 1,
        })   
    end)
    
    self.space = holograms.create(pos, Angle(90,-90,0), "models/holograms/plane.mdl",Vector(self.size))
    self.space:setMaterial("!" .. self.mat:getName())
    
    if parent then
        self.space:setParent(parent)
    end

    hook.add("think","space_"..table.address(self),function()
        self.space:setAngles((player():getEyePos()-self.space:getPos()):getAngle()+Angle(90,0,0))
    end)
    
    return self
end

function renderer:setViewScale(viewScale)
    self.viewScale=viewScale
end